<h1>BT的Merkle Tree</h1>
<br /><h2>相关知识：</h2>
<br />&emsp;&emsp;BT即BitTorrent,是一种中心索引式的P2P文件分析通信协议；优点为：一、加快了下载速度；二、减轻了下载服务器的负担；该协议要进行下载必须从中心索引服务器中获取一个
索引文件，包含要共享文件的信息，其中的哈希信息在下载时要进行验证，因此为了防止数据块过大，可以使用Merkle Tree来解决。
<br /><h2>实现思路：</h2>
<br />&emsp;&emsp;用一个简单的Merkle Tree代替Hash List，设计一个层数足够多的满二叉树，叶子节点是数据块的hash，不足的叶节点用0来代替，上层的节点是对其对应孩子节点串联的hash。
<br />&emsp;&emsp;Hash算法使用SHA1，数据传输过程为：在构造Merkle树时，首先对数据块计算哈希值，然后将数据块计算的哈希值两两配对（如果是奇数个数，最后一个和自己配对），计算上一层哈希，再重复这个步骤，一直到计算出根哈希值。该Merkle树可以用来进行完整性验证，在分布式环境下只要验证Merkle树根哈希一致即可。
<br />&emsp;&emsp;如果某一数据块发生错误（比如数据被修改了），错误会一级级传播，最后导致根哈希值不一致，在查找错误时，可以从根节点开始，一级一级查找，最终找到错误数据地点。
<br /><h2>详细过程</h2>
<br />1.以下载大文件A为例，为启动BT交换，每一个客户端需从索引服务器中下载索引文件，从而得到文件相关信息；
<br />2.任一用户端均可通过轮询Tracking服务器或者是DHT方式来定位其他参与交换A数据的组网，进而与之建立TCP连接进行P2P文件交换，其定位组网的方式基本上没什么改变；
<br />3.当用户端从组网下载一个数据块时，它将事先发出校验查询的请求，组网要提供校验当前下载块所需的全部路径的哈希值，当用户端下载完某数据块之后，它将对其进行哈希树
校验；根据组网提供的信息进行计算根哈希，若计算结果与Merkle Tree的根哈希值相同，则数据块下载无误，校验通过；反之则校验失败;
<br />4.若数据块校验通过，与其哈希树校验过程的所有路径哈希值均可以作为cache缓存下来；若该数据块的校验未通过，则其所有相关的路径哈希值均不能被cache，而只能被废弃;
<br /><h2>时空效率</h2>
<br />假设某文件的总块数为M，将其padding至N个块(N＝2^p)，块长为K:
<br />校验整个文件共需缓存Sum(2^i)：i=0 to p，即2N-1个20字节的SHA1哈希值(包含根哈希值、所有路径哈希值和块哈希值)；
<br />在无校验失败的理想情况下，校验整个文件共需M次块长为K的SHA1计算，和N-1次长度为20字节的SHA1运算。
